{// 引入标签库 }
<tagLib name="html" />
<include file="Public:header" />
<load href='__TMPL__Common/js/jquery.bgiframe.js' />
<load href='__TMPL__Common/js/jquery.weebox.js' />
<load href='__TMPL__Common/js/user.js' />
<load href='__TMPL__Common/style/weebox.css' />
<load href='__TMPL__Common/js/deal_order.js' />
<PHP>
function get_delivery_sn($deal_order_item_id)
{
	$delivery_notice = M("DeliveryNotice")->where("order_item_id=".$deal_order_item_id)->order("delivery_time desc")->find();
	$order_id = M("DealOrderItem")->where("id=".$delivery_notice['order_item_id'])->getField("order_id");
	$order_item_id = M("DealOrderItem")->where("id=".$delivery_notice['order_item_id'])->getField("id");
	$express_id = M("DeliveryNotice")->where("order_item_id=".$order_item_id)->getField("express_id");
	$express = M("Express")->where("id=".$express_id)->getField("name");
	$res = $delivery_notice['notice_sn'];
	if($delivery_notice['express_id']!=0)
	{
		$res.="<br />承运快递：".$express." <br /><a href='".U("Express/eprint",array("order_id"=>$order_id,"express_sn"=>$delivery_notice['notice_sn'],"express_id"=>$delivery_notice['express_id']))."' target='_blank'>".l("PRINT_EXPRESS")."</a> <a href='javascript:void(0);' onclick='track_express(\"".$delivery_notice['notice_sn']."\",\"".$delivery_notice['express_id']."\");'>".l("TRACK_EXPRESS")."</a>";
	}
	return $res;
}

function get_delivery_arrival($deal_order_item_id)
{
	$delivery_notice =  M("DeliveryNotice")->where("order_item_id=".$deal_order_item_id)->order("delivery_time desc")->find();
	if($delivery_notice['is_arrival']==1)
	{
		return l("USER_CONFIRM_DELIVERY");
	}
	elseif($delivery_notice['is_arrival']==2)
	{
		return "<span style='color:#f30;'>用户未收到货，维权</span>";
	}
	else
	{
		return l("USER_NOT_CONFIRM_DELIVERY");
	}
}
function get_no_delivery_arrival($deal_order_item_id)
{
	$delivery_notice =  M("DealOrderItem")->where("id=".$deal_order_item_id)->find();
	if($delivery_notice['is_arrival']==1)
	{
		return l("USER_CONFIRM_DELIVERY");
	}
	elseif($delivery_notice['is_arrival']==2)
	{
		return "<span style='color:#f30;'>用户未收到货，维权</span>";
	}
	else
	{
		return l("USER_NOT_CONFIRM_DELIVERY");
	}
}
function get_delivery_memo($deal_order_item_id)
{
	return M("DeliveryNotice")->where("order_item_id=".$deal_order_item_id)->getField("memo");
	
}

function get_coupon($item_id){
	 
	return M("DealCoupon")->where("order_deal_id=".$item_id)->getField("password");
	 
}

function get_coupon_time($time){
	if($time > 0){
		return to_date($time);
	}else{
		return '无限期';
	}
}

function get_coupon_status($is_valid){
	if($is_valid==0){
		return '未发劵';
	}elseif($is_valid==1){
		return '已发劵';
	}elseif($is_valid==2){
		return '已使用';
	}
}

</PHP>
<script type="text/javascript">
	function track_express(express_sn,express_id)
	{	
		var newTab=window.open('about:blank');
		$.ajax({ 
				url: "<?php echo u("DealOrder/check_delivery");?>&express_sn="+express_sn+"&express_id="+express_id, 
				data: "ajax=1",
				dataType: "json",
				success: function(obj){
					
					if(obj.status==1)
					{
						newTab.location.href=obj.msg;
					}
					if(obj.status==0)
					{
						alert(obj.msg);
					}				
				}
		});		
	}

	var dist_search_url = '{:u("Distribution/keySearch")}';
</script>
<div class="main">
<div class="main_title">{$title}：{$order_info.order_sn}

</div>
<div class="blank5"></div>

<h2 class="info-title-h2">订单信息</h2>
<table class="form" cellpadding=0 cellspacing=0>
	<tr class="order_detail">
		<td class="item_title">订单状态:</td>
		<td class="item_input">
			{$order_info.order_status|get_order_status=$order_info}
		</td>
		
		<td class="item_title">{%ORDER_SN}:</td>
		<td class="item_input">{$order_info.order_sn}</td>
	</tr>
	<tr class="order_detail">
		<td class="item_title">发货状态:</td>
		<td class="item_input">{$order_info.delivery_status|get_delivery_status=$order_info}</td>
		<td class="item_title">下单时间:</td>
		<td colspan="3" class="item_input">{$order_info.create_time|to_date}</td>

	</tr>
	<if condition="$type eq 4">
		<tr class="order_detail">
			<td class="item_title">驿站</td>
			<td class="item_input">{$order_info.distribute}<if condition="$order_info.delivery_status eq 0">&nbsp;&nbsp;<a href="javascript:void(0);" class="dist_choose" action="{:u("DealOrder/changeDist", array("id" => $order_info['id']))}">分配</a></if></td>
		</tr>
	</if>
</table>

<h2 class="info-title-h2">付款信息</h2>
<table class="form" cellpadding=0 cellspacing=0>
	<tr class="order_detail">
		<td class="item_title">{%ORDER_USER}:</td>
		<td class="item_input">
			{$order_info.user_id|get_user_name_js}
		</td>
		
		<td class="item_title">{%ORDER_DEAL_TOTAL_PRICE}:</td>
		<td class="item_input">{$order_info.deal_total_price|format_price}</td>
		
	</tr>
	<tr class="order_detail">
		<td class="item_title">支付方式:</td>
		<td class="item_input">{$order_info['id']|get_order_payment_name}</td>
	
		<td class="item_title">配送费用:</td>
		<td class="item_input">{$order_info.delivery_fee|format_price}</td>
	</tr>
	<tr class="order_detail">
		<td class="item_title">返现:</td>
		<td class="item_input">{$order_info.return_total_money|format_price}</td>
		
		<td class="item_title">红包优惠:</td>
		<td class="item_input">{$order_info.ecv_money|format_price}</td>
	</tr>
	<tr class="order_detail">
		<td class="item_title"><if condition="$order_info['type'] eq 2">消耗积分:<else />返积分:</if></td>
		<td class="item_input">{$order_info.return_total_score}</td>
	
		<td class="item_title">会员等级折扣:</td>
		<td class="item_input">{$order_info.discount_price|format_price}</td>	
	</tr>
	<tr class="order_detail">
		<td class="item_title">订单备注:</td>
		<td class="item_input">{$order_info.memo}</td>
		<td class="item_title">积分抵扣:</td>
		<td class="item_input">{$order_info.exchange_money|format_price}</td>
	</tr>
	<tr class="order_detail">
		<td class="item_title"></td>
		<td class="item_input"></td>
		<td class="item_title">店铺优惠:</td>
		<td class="item_input">{$order_info.youhui_money|format_price}</td>
	</tr>
	<tr class="order_detail">
		<td class="item_title"></td>
		<td class="item_input"></td>
		<td class="item_title">实付金额:</td>
		<td class="item_input"><b style="color:red;">{$order_info.pay_price|format_price}</b></td>
	</tr>
</table>

<if condition="$order_info['delivery_status'] neq 5 and $delivery_type neq 2">
<h2 class="info-title-h2">配送信息</h2>
	<table class="form" cellpadding=0 cellspacing=0>
		<tr class="order_detail">
			<td class="item_title">收货人:</td>
			<td class="item_input">{$order_info.consignee}</td>
			
			<td class="item_title">联系电话</td>
			<td class="item_input">{$order_info.mobile}</td>
		</tr>
		
		<tr class="order_detail">
			<td class="item_title">邮编</td>
			<td class="item_input">{$order_info.zip}</td>
			
			<td class="item_title">收货地址:</td>
			<td colspan=3 class="item_input">{$order_info.region_lv2} {$order_info.region_lv3} {$order_info.region_lv4} {$order_info.address}{$order_info.street}{$order_info.doorplate}</td>
		</tr>
	</table>
</if>


<!-- 自营驿站配送 
<if condition="$order_info['type'] neq 4">
	<h2 class="info-title-h2">配送信息</h2>
	<table class="form" cellpadding=0 cellspacing=0>
		
		<tr class="order_detail">
			<td class="item_title">配送方式:</td>
			<td class="item_input">驿站配送（福州 - 苏宁站）</td>
			
			<td class="item_title">联系电话</td>
			<td class="item_input">{$order_info.mobile}</td>
		</tr>
		
		<tr class="order_detail">
			<td class="item_title">收货人:</td>
			<td class="item_input">{$order_info.consignee}</td>
			
			<td class="item_title">联系电话</td>
			<td class="item_input">{$order_info.mobile}</td>
		</tr>
		
		<tr class="order_detail">
			<td class="item_title">邮编</td>
			<td class="item_input">{$order_info.zip}</td>
			
			<td class="item_title">收货地址:</td>
			<td colspan=3 class="item_input">{$order_info.region_lv2} {$order_info.region_lv3} {$order_info.region_lv4} {$order_info.address}</td>
		</tr>
	</table>
</if>
-->
<div class="blank5"></div>

<!-- 发票信息 -->
<if condition="!empty($order_info['invoice_info'])">
<h2 class="info-title-h2">发票信息</h2>
<table class="form" cellpadding=0 cellspacing=0>
	<tr class="order_detail">
		<td class="item_title">发票类型:</td>
		<td class="item_input">普通发票</td>
		
		<td class="item_title">发票抬头</td>
		<td class="item_input">{$order_info.invoice_info.persons}</td>
	</tr>
	
	<tr class="order_detail">
		<td class="item_title">发票内容:</td>
		<td class="item_input">{$order_info.invoice_info.content}</td>
		<if condition="isset($order_info['invoice_info']['taxnu'])">
		<td class="item_title">纳税人识别码</td>
		<td class="item_input">{$order_info.invoice_info.taxnu}</td>
		</if>
	</tr>
</table>
</if>

<div class="blank5"></div>

<!-- 团购订单 -->
<if condition="$order_info['type'] eq 5">
	<h2 class="info-title-h2">团购信息</h2>
	<table class="form" cellpadding=0 cellspacing=0>
		<tr>
			<th width=60>商品ID</th>
			<th width=200>商品名称</th>
			<th width=80>单价</th>
			<th width=150>商家</th>
			<th width=100>发券状态</th>
			<th width=150>过期时间</th>
			<th width=150>核销时间</th>
			<th width=120>消费券</th>
			<th width=65>商品状态</th>
			<th width=150>操作</th>
		</tr>
	
		
		<foreach name="coupon_list"  item="deal_item">
			<tr>
				<td>{$deal_item.deal_id}</td>
				<td>{$deal_item.deal_name}</td>
				<td>{$deal_item.coupon_price|format_price}</td>
				<td>
					<a href='{:u("Supplier/index",array("id"=>$deal_item['supplier_id']))}'>{$deal_item.supplier_name}</a>
				</td>
				
				<td>
					<if condition="$deal_item['is_coupon'] eq 0">
						{:l("COUPON_IS_VALID_NULL")}
						<else/>
						{$deal_item.is_valid|get_coupon_status}
						
					</if>

				</td>
				
				<td>
					<if condition="$deal_item['is_coupon'] eq 0">
						-
						<else/>
						
						{$deal_item.end_time|get_coupon_time}
					</if>

				</td>
				
				<td>
					<if condition="$deal_item['is_coupon'] eq 0">
						-
						<else/>
						{$deal_item.confirm_time|to_date}
					</if>

				</td>
				
				<td>
					{$deal_item.password}
				</td>
				
				<td>
					<if condition="$deal_item['is_coupon'] eq 0">
						-
						<else/>
						{$deal_item.refund_status|get_coupon_refund_status=$deal_item}
					</if>

				</td>
				
				<td style="text-align:center;" class="deal_operate">
					<if condition="$deal_item['is_coupon'] eq 0">
						-
						<else/>
						{$deal_item.refund_status|get_coupon_operate=$deal_item}
					</if>

				</td>
			</tr>
		</foreach>
		 
		 
	</table>

<else />

	<h2 class="info-title-h2">商品信息</h2>
	<table class="form" cellpadding=0 cellspacing=0>
		<tr>
			<th width=60>商品ID</th>
			<th width=300>商品名称</th>
			<th width=50>数量</th>
			<th width=80>单价</th>
			<th width=80>总计</th>
			<th width=200>商家</th>
			
			<if condition="$is_pick eq 1">
			<th width=200>自提码</th>
			</if>
			
			
			<th width=250>发货状态</th>
			<th width=250>商品状态</th>
			<th width=200>操作</th>
		</tr>
	
		<?php foreach($order_deals as $key=>$deal_item_group ){ ?>
			<foreach name="deal_item_group['goods_list']"  item="deal_item">
				<tr>
					<td>{$deal_item.deal_id}</td>
					<td>{$deal_item.name}</td>
					<td>{$deal_item.number}</td>
					<td>{$deal_item.unit_price|format_price}</td>
					<td><if condition="$deal_item['buy_type'] neq 1">{$deal_item.total_price|format_price}<else/>{$deal_item.return_total_score|abs}积分</if></td>
					
					<td>
						<a href='{:u("Supplier/index",array("id"=>$deal_item['supplier_id']))}'>{$deal_item.supplier_id|get_supplier_name}</a>
					</td>
					
					
					<if condition="$is_pick eq 1">
					 <td>
						{$deal_item.id|get_coupon=$deal_item.id}
					</td>
					</if>
					
					<td>
						{$deal_item.delivery_status|get_deal_item_delivery_status=$deal_item}
					</td>
					
					<td>
						 {$order_info.pay_status|get_deal_status=$deal_item}
					</td>
					
					<td style="text-align:center;" class="deal_operate">
						{$order_info.pay_status|get_deal_operate=$deal_item}
					</td>
				</tr>
			</foreach>
		<?php } ?>
		 
	</table>

</if>

<div class="blank5"></div>
<if condition="$payment_notice">
<h2 class="info-title-h2">付款单</h2>
<table class="form" cellpadding=0 cellspacing=0>
	<tr>
		<th>{%PAYMENT_NOTICE_SN}</th>
		<th>{%OUTER_NOTICE_SN}</th>
		<th>{%PAY_TIME}</th>
		<th>{%PAYMENT_METHOD}</th>
		<th>{%PAYMENT_MEMO}</th>
		<th>{%PAYMENT_AMOUNT}</th>
	</tr>
	<foreach name="payment_notice" item="notice_item">
	<tr>
		<td>{$notice_item.notice_sn}</td>
		<td>{$notice_item.outer_notice_sn}</td>
		<td>{$notice_item.pay_time|to_date}</td>
		<td>{$notice_item.payment_id|get_payment_name}</td>
		<td>{$notice_item.memo}</td>
		<td><b style="color:red;">{$notice_item.money|format_price}</b></td>
	</tr>
	</foreach>
	<tr>
		<td colspan=6 class="bottomTd"></td>
	</tr>
</table>
</if>
 
<if condition="$log_list">
<h2 class="info-title-h2">操作日志</h2>
	<table class="form" cellpadding=0 cellspacing=0>
		<tr><th>操作时间</th><th colspan=2>日志</th></tr>
			<foreach name="log_list" item="log_item">
			<tr>
				<td style="width:200px;text-align:center;">{$log_item.log_time|to_date}</td>
				<td>{$log_item.log_info}</td>
			</tr>
			</foreach>
		<tr>
		<td colspan=2 class="bottomTd"></td>
		</tr>
	</table>
	<div class="blank5"></div>
</if>

</div>
<include file="Public:footer" />